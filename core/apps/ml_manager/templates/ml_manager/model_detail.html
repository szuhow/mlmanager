{% extends "ml_manager/base.html" %}
{% load static %}
{% load l10n %}

{% block title %}{{ model.name }} - Details{% endblock %}

{% block extra_css %}
<style>
/* Remove dark mode and custom log coloring, use default Bootstrap */
.log-display, .log-section, .log-entry, #modal-logs-content {
    background: none !important;
    color: inherit !important;
    border-radius: 0 !important;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.4;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    padding: 0;
}

#modal-logs-content {
    background-color: #fff !important;
    color: #212529 !important;
    font-family: 'Courier New', monospace;
}

.log-entry {
    background: none !important;
    color: inherit !important;
    border-left: none !important;
    font-weight: normal !important;
    padding: 2px 0;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid" data-model-id="{{ model.pk }}" data-model-status="{{ model.status }}" data-model-created-at="{{ model.created_at|date:'c' }}">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ model.name }}</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="openLogsModal()">
                <i class="fas fa-file-alt me-1"></i>
                Training Logs
                {% if model.status == 'training' %}
                <span class="badge bg-warning ms-1">Live</span>
                {% elif model.status == 'completed' %}
                <span class="badge bg-success ms-1">Complete</span>
                {% elif model.status == 'failed' %}
                <span class="badge bg-danger ms-1">Failed</span>
                {% endif %}
            </button>
            <a href="{% url 'ml_manager:model-inference' model.pk %}" class="btn btn-primary">Run Inference</a>
            <a href="{% url 'ml_manager:model-list' %}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>

    {% if mlflow_error %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>MLflow Warning:</strong> {{ mlflow_error }}
        <br><small>Training data may still be displayed from cached model information.</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            <!-- Model Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Model Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            <span class="badge {% if model.status == 'completed' %}bg-success{% elif model.status == 'training' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ model.status }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">MLflow Run ID</dt>
                        <dd class="col-sm-8">
                            {{ model.mlflow_run_id }}
                            {% if mlflow_ui_url %}
                            <br>
                            <a href="{{ mlflow_ui_url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-external-link-alt me-1"></i>View in MLflow
                            </a>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Training Progress Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Training Progress</h5>
                </div>
                <div class="card-body" id="training-progress">
                    {% if model.status == 'training' %}
                    <div class="progress progress-enhanced mb-3">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ progress_percentage|default:0 }}%"
                             aria-valuenow="{{ model.current_epoch }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ model.total_epochs }}">
                            Epoch {{ model.current_epoch }}/{{ model.total_epochs }} ({{ progress_percentage|default:0 }}%)
                        </div>
                    </div>
                    
                    <!-- Batch progress within current epoch -->
                    {% if model.total_batches_per_epoch > 0 %}
                    <div class="progress progress-sm mb-3" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" 
                             style="width: {{ model.batch_progress_percentage|default:0 }}%"
                             aria-valuenow="{{ model.current_batch }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ model.total_batches_per_epoch }}">
                        </div>
                    </div>
                    <small class="text-muted mb-3 d-block">
                        Batch {{ model.current_batch }}/{{ model.total_batches_per_epoch }} in current epoch
                    </small>
                    {% endif %}
                    
                    <div class="training-metrics">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="metric-item">
                                    <span class="metric-label">Current Epoch:</span>
                                    <span class="metric-value"><span id="current-epoch">{{ model.current_epoch }}</span> / <span id="total-epochs">{{ model.total_epochs }}</span></span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Training Loss:</span>
                                    <span class="metric-value" id="train-loss">{{ model.train_loss|floatformat:4 }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Training Dice:</span>
                                    <span class="metric-value" id="train-dice">{{ model.train_dice|floatformat:4 }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-item">
                                    <span class="metric-label">Validation Loss:</span>
                                    <span class="metric-value" id="val-loss">{{ model.val_loss|floatformat:4 }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Validation Dice:</span>
                                    <span class="metric-value" id="val-dice">{{ model.val_dice|floatformat:4 }}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Best Validation Dice:</span>
                                    <span class="metric-value" id="best-val-dice">{{ model.best_val_dice|floatformat:4 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <button id="stopTrainingBtn" class="btn btn-danger"
                                {% if model.stop_requested %}disabled{% endif %}>
                            {% if model.stop_requested %}Stop Requested{% else %}Stop Training{% endif %}
                        </button>
                        
                        <div class="d-flex align-items-center gap-3">
                            <button id="manualRefreshBtn" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-sync-alt"></i> Refresh Now
                            </button>
                            
                            <small class="text-muted">
                                <span id="last-update-time">Updates every 2 seconds</span>
                            </small>
                            
                            <div id="update-status" class="text-success" style="display: none;">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Live
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-{{ model.status|yesno:'success,danger' }}">
                        <strong>Training {{ model.status|title }}</strong>
                        {% if model.status == 'completed' %}
                            <br><small>Training completed successfully!</small>
                        {% elif model.status == 'failed' %}
                            <br><small>Training failed. Check logs for details.</small>
                        {% endif %}
                    </div>
                    
                    {% if model.best_val_dice %}
                    <div class="training-metrics">
                        <div class="metric-item">
                            <span class="metric-label">Final Validation Dice:</span>
                            <span class="metric-value">{{ model.best_val_dice|floatformat:4 }}</span>
                        </div>
                        {% if model.train_loss %}
                        <div class="metric-item">
                            <span class="metric-label">Final Training Loss:</span>
                            <span class="metric-value">{{ model.train_loss|floatformat:4 }}</span>
                        </div>
                        {% endif %}
                        {% if model.val_loss %}
                        <div class="metric-item">
                            <span class="metric-label">Final Validation Loss:</span>
                            <span class="metric-value">{{ model.val_loss|floatformat:4 }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <!-- Dataset Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database me-2"></i>Dataset Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if model.training_data_info %}
                    <dl class="row">
                        <dt class="col-sm-4">Dataset Type</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">
                                {{ model.training_data_info.dataset_type|default:"auto"|title }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-4">Data Path</dt>
                        <dd class="col-sm-8">
                            <code>{{ model.training_data_info.data_path|default:"N/A" }}</code>
                        </dd>
                        
                        <dt class="col-sm-4">Dataset Size</dt>
                        <dd class="col-sm-8">
                            {% if model.training_data_info.total_samples %}
                                <strong>{{ model.training_data_info.total_samples }}</strong> samples
                                {% if model.training_data_info.training_samples %}
                                    <br><small class="text-muted">
                                        Train: {{ model.training_data_info.training_samples }}, 
                                        Val: {{ model.training_data_info.validation_samples|default:"Unknown" }}
                                    </small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Image Resolution</dt>
                        <dd class="col-sm-8">{{ model.training_data_info.resolution|default:"256" }}px</dd>
                    </dl>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Dataset information not available for this model.</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- MLflow Model Registry Information -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-archive me-2"></i>MLflow Registry
                    </h5>
                    <div class="btn-group btn-group-sm">
                        {% if model.is_registered %}
                            <button class="btn btn-outline-primary btn-sm" onclick="syncRegistryInfo({{ model.pk }})">
                                <i class="fas fa-sync-alt"></i> Sync
                            </button>
                        {% else %}
                            <button class="btn btn-primary btn-sm" onclick="registerModel({{ model.pk }})">
                                <i class="fas fa-plus"></i> Register
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if model.is_registered %}
                    <dl class="row">
                        <dt class="col-sm-4">Registry Name</dt>
                        <dd class="col-sm-8" id="registry-name">{{ model.registry_model_name }}</dd>
                        
                        <dt class="col-sm-4">Version</dt>
                        <dd class="col-sm-8" id="registry-version">v{{ model.registry_model_version }}</dd>
                        
                        <dt class="col-sm-4">Stage</dt>
                        <dd class="col-sm-8">
                            <span id="registry-stage" class="badge 
                                {% if model.registry_stage == 'Production' %}bg-success
                                {% elif model.registry_stage == 'Staging' %}bg-warning
                                {% elif model.registry_stage == 'Archived' %}bg-secondary
                                {% else %}bg-light text-dark{% endif %}">
                                {{ model.registry_stage|default:"None" }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-4">Registered</dt>
                        <dd class="col-sm-8">
                            <i class="fas fa-check-circle text-success"></i>
                            <small class="text-muted">Model is registered in MLflow Registry</small>
                        </dd>
                    </dl>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Not Registered</strong><br>
                        <small>This model is not yet registered in MLflow Model Registry. Click "Register" to add it for better version management and deployment tracking.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Training Configuration Section (Full Width) -->
    {% if training_details %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Training Configuration
                    </h5>
                </div>
                <div class="card-body">
                    {% if training_details.error %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ training_details.error }}
                        </div>
                    {% else %}
                        <div class="row">
                            <!-- Basic Configuration -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-sliders-h me-1"></i>Training Parameters</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Batch Size:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.batch_size|default:"N/A" }}</dd>
                                    
                                    <dt class="col-sm-5">Epochs:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.epochs|default:"N/A" }}</dd>
                                    
                                    <dt class="col-sm-5">Learning Rate:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.learning_rate|default:"N/A" }}</dd>
                                    
                                    <dt class="col-sm-5">Validation Split:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.validation_split|default:"N/A" }}</dd>
                                    
                                    <dt class="col-sm-5">Crop Size:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.crop_size|default:"N/A" }}px</dd>
                                    
                                    <dt class="col-sm-5">Workers:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.num_workers|default:"N/A" }}</dd>
                                </dl>
                            </div>

                            <!-- Hardware & Environment -->
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-microchip me-1"></i>Hardware & Environment</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Device:</dt>
                                    <dd class="col-sm-7">
                                        <span class="badge {% if training_details.hardware.device == 'cuda' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ training_details.hardware.device|default:"N/A"|upper }}
                                        </span>
                                        {% if training_details.hardware.config_device and training_details.hardware.config_device != training_details.hardware.device %}
                                            <small class="text-muted">(configured: {{ training_details.hardware.config_device }})</small>
                                        {% endif %}
                                    </dd>
                                    
                                    <dt class="col-sm-5">PyTorch Version:</dt>
                                    <dd class="col-sm-7">{{ training_details.hardware.pytorch_version|default:"N/A" }}</dd>
                                    
                                    <dt class="col-sm-5">CUDA Available:</dt>
                                    <dd class="col-sm-7">
                                        {% if training_details.hardware.cuda_available %}
                                            <i class="fas fa-check-circle text-success"></i> Yes
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i> No
                                        {% endif %}
                                    </dd>
                                    
                                    <dt class="col-sm-5">Model Type:</dt>
                                    <dd class="col-sm-7">{{ training_details.config.model_type|default:"N/A"|upper }}</dd>
                                </dl>
                            </div>
                        </div>

                        <!-- Data Augmentation Section -->
                        {% if training_details.augmentation %}
                        <hr class="my-4">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-info mb-3"><i class="fas fa-random me-1"></i>Data Augmentation</h6>
                                <div class="row row-cols-2 row-cols-md-4 g-3">
                                    <div class="col">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                {% if training_details.augmentation.random_flip %}
                                                    <i class="fas fa-arrows-alt-h text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-arrows-alt-h text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <small class="fw-bold">Random Flip</small><br>
                                                <span class="badge {% if training_details.augmentation.random_flip %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {% if training_details.augmentation.random_flip %}Enabled{% else %}Disabled{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                {% if training_details.augmentation.random_rotate %}
                                                    <i class="fas fa-sync-alt text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-sync-alt text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <small class="fw-bold">Random Rotate</small><br>
                                                <span class="badge {% if training_details.augmentation.random_rotate %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {% if training_details.augmentation.random_rotate %}Enabled{% else %}Disabled{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                {% if training_details.augmentation.random_scale %}
                                                    <i class="fas fa-expand-arrows-alt text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-expand-arrows-alt text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <small class="fw-bold">Random Scale</small><br>
                                                <span class="badge {% if training_details.augmentation.random_scale %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {% if training_details.augmentation.random_scale %}Enabled{% else %}Disabled{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                {% if training_details.augmentation.random_intensity %}
                                                    <i class="fas fa-adjust text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-adjust text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <small class="fw-bold">Random Intensity</small><br>
                                                <span class="badge {% if training_details.augmentation.random_intensity %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {% if training_details.augmentation.random_intensity %}Enabled{% else %}Disabled{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Training Samples Section (Full Width) -->
    {% if training_preview %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-images me-2"></i>Training Samples
                        {% if training_preview.latest_epoch %}
                            <small class="text-muted">Latest: Epoch {{ training_preview.latest_epoch }}</small>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if training_preview.error %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ training_preview.error }}
                        </div>
                    {% elif training_preview.images %}
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Prediction samples generated during training. Shows model performance evolution across epochs.
                        </p>
                        <div class="training-samples-container">
                            <div class="row">
                                {% for image in training_preview.images %}
                                <div class="col-md-6 col-lg-4 mb-3" data-epoch="{{ image.epoch }}">
                                    <div class="card">
                                        <div class="card-header py-2">
                                            <small class="text-muted">Epoch {{ image.epoch }}</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <img src="{% url 'ml_manager:training-preview-image' model.id image.filename %}" 
                                                 class="img-fluid training-sample-image" 
                                                 alt="Epoch {{ image.epoch }} predictions"
                                                 style="max-height: 300px; width: 100%; object-fit: contain; cursor: pointer;"
                                                 data-epoch="{{ image.epoch }}"
                                                 data-image-url="{% url 'ml_manager:training-preview-image' model.id image.filename %}"
                                                 onclick="openTrainingImageModal({{ image.epoch }})">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-images fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No Training Samples Yet</h6>
                            <p class="text-muted mb-0">
                                {% if model.status == 'training' %}
                                    Sample images will appear here after the first epoch completes.
                                {% elif model.status == 'completed' %}
                                    No sample images were generated during training.
                                {% else %}
                                    Training samples will be available once training starts.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Rerun Training Button -->
    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'ml_manager:start-training' %}?rerun={{ model.id }}" class="btn btn-warning">
        <i class="fas fa-redo"></i> Rerun Training
      </a>
    </div>
</div>

<!-- Training Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logsModalLabel">
          <i class="fas fa-file-alt"></i> Training Logs - {{ model.name }}
        </h5>
        <div class="d-flex gap-2 align-items-center">
          <!-- Refresh button -->
          <button class="btn btn-outline-info btn-sm" id="modal-refresh-logs">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <!-- Log statistics -->
        <div class="bg-light border-bottom p-3">
          <div class="row text-center">
            <div class="col">
              <small class="text-muted">Total Lines: <span id="modal-total-lines">0</span></small>
            </div>
            <div class="col">
              <small class="text-muted">Model: <strong>{{ model.name }}</strong></small>
            </div>
            <div class="col">
              <small class="text-muted">Status: <strong>{{ model.status|title }}</strong></small>
            </div>
          </div>
        </div>
        
        <!-- Logs content -->
        <div id="modal-logs-content" style="height: 60vh; overflow-y: auto; padding: 1rem; font-family: 'Courier New', monospace;">
          <div class="text-center py-5">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2">Loading logs...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i> 
            Showing model-specific logs only.
          </small>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal for Training Samples -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center">
          <button type="button" class="btn btn-outline-primary btn-sm me-2" id="prevImageBtn" onclick="navigateTrainingImage(-1)" title="Previous Epoch">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h5 class="modal-title mb-0" id="imageModalLabel">Training Sample</h5>
          <button type="button" class="btn btn-outline-primary btn-sm ms-2" id="nextImageBtn" onclick="navigateTrainingImage(1)" title="Next Epoch">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadImage()" title="Download">
            <i class="fas fa-download"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body text-center p-0" id="imageModalBody" style="overflow: hidden; position: relative; height: 80vh;">
        <div id="imageContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
          <img id="modalImage" src="" alt="" 
               style="max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain;"
               ondragstart="return false;"
               onload="console.log('Image loaded successfully')"
               onerror="console.error('Failed to load image:', this.src)">
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          <i class="fas fa-info-circle"></i> 
          Training sample image - Click download to save the image.
        </small>
        <div class="d-flex align-items-center gap-3">
          <span id="epochNavigationInfo" class="badge bg-primary"></span>
          <span id="imageInfo" class="text-muted"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Load static files -->
{% load static %}

<!-- Include Simple Model Detail Manager -->
<script src="{% static 'ml_manager/js/model_detail_simple.js' %}"></script>

<!-- Initialize JavaScript Components -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get model data from template
    const modelId = {{ model.id|unlocalize }};
    
    // Initialize unified manager
    window.modelDetailManager = new ModelDetailManager(modelId);
    
    // Initialize epoch navigation if training images exist
    const hasEpochImages = document.querySelectorAll('[data-epoch]').length > 0;
    if (hasEpochImages) {
        window.epochNavigator = new EpochNavigator();
    }
});

// Global functions for template compatibility
function openImageModal(imageUrl, title) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageModalLabel');
    
    if (modal && modalImage && modalTitle) {
        modalImage.src = imageUrl;
        modalImage.alt = title;
        modalTitle.textContent = title;
        
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    }
}

function downloadImage() {
    const modalImage = document.getElementById('modalImage');
    if (modalImage && modalImage.src) {
        const a = document.createElement('a');
        a.href = modalImage.src;
        a.download = modalImage.alt || 'training_image.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}

function showPreviousEpoch() {
    if (window.epochNavigator) {
        window.epochNavigator.previous();
    }
}

function showNextEpoch() {
    if (window.epochNavigator) {
        window.epochNavigator.next();
    }
}

// MLflow Registry Management Functions - Delegated to unified manager
function registerModel(modelId) {
    if (window.modelDetailManager) {
        window.modelDetailManager.registerModel(modelId);
    }
}

function syncRegistryInfo(modelId) {
    if (window.modelDetailManager) {
        window.modelDetailManager.syncRegistryInfo(modelId);
    }
}

// Logs Modal Functions - Delegated to unified manager
function openLogsModal() {
    if (window.modelDetailManager) {
        window.modelDetailManager.openLogsModal();
    }
}

function loadModalLogs() {
    if (window.modelDetailManager) {
        window.modelDetailManager.loadModalLogs();
    }
}

// Initialize refresh button functionality
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('modal-refresh-logs');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;
            
            // Delegate to unified manager
            if (window.modelDetailManager) {
                window.modelDetailManager.loadModalLogs();
            }
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 1000);
        });
    }
});

// Training image navigation for modal
let trainingImages = [];
let currentImageIndex = 0;

// Initialize training images data
function initializeTrainingImages() {
    trainingImages = [];
    const imageElements = document.querySelectorAll('.training-sample-image[data-epoch]');
    
    imageElements.forEach((img, index) => {
        trainingImages.push({
            epoch: parseInt(img.dataset.epoch),
            url: img.dataset.imageUrl,
            title: img.alt,
            index: index
        });
    });
    
    // Sort by epoch
    trainingImages.sort((a, b) => a.epoch - b.epoch);
    console.log('Initialized training images:', trainingImages);
}

// Open training image modal with navigation
function openTrainingImageModal(epochNumber) {
    initializeTrainingImages();
    
    // Find the index of the selected epoch
    const imageIndex = trainingImages.findIndex(img => img.epoch === epochNumber);
    if (imageIndex === -1) {
        console.error('Image not found for epoch:', epochNumber);
        return;
    }
    
    currentImageIndex = imageIndex;
    showImageInModal();
    
    const modal = document.getElementById('imageModal');
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}

// Navigate between training images
function navigateTrainingImage(direction) {
    const newIndex = currentImageIndex + direction;
    
    if (newIndex >= 0 && newIndex < trainingImages.length) {
        currentImageIndex = newIndex;
        showImageInModal();
    }
}

// Update modal content with current image
function showImageInModal() {
    if (trainingImages.length === 0) return;
    
    const currentImage = trainingImages[currentImageIndex];
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageModalLabel');
    const epochInfo = document.getElementById('epochNavigationInfo');
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    
    // Update image and title
    modalImage.src = currentImage.url;
    modalImage.alt = currentImage.title;
    modalTitle.textContent = `Training Sample - Epoch ${currentImage.epoch}`;
    
    // Update epoch info badge
    epochInfo.textContent = `Epoch ${currentImage.epoch} (${currentImageIndex + 1}/${trainingImages.length})`;
    
    // Update navigation buttons
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === trainingImages.length - 1;
    
    console.log('Showing image:', currentImage);
}

// Keyboard navigation support
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('imageModal');
    if (modal.classList.contains('show')) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateTrainingImage(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateTrainingImage(1);
        }
    }
});
</script>


{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

{% if model is None %}
  <div class="alert alert-danger">Model context variable is missing!</div>
{% endif %}

{% if mlflow_error %}
  <div class="alert alert-warning">MLflow error: {{ mlflow_error }}</div>
{% endif %}

{% endblock content %}

{% extends "ml_manager/base.html" %}

{% block title %}Start Training - ML Manager{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Start New Training</h2>
                <div>
                    <a href="{% url 'ml_manager:template-list' %}" class="btn btn-info">
                        <i class="fas fa-clipboard-list"></i> Manage Templates
                    </a>
                    <a href="{% url 'ml_manager:model-list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Models
                    </a>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Training Configuration</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="training-form">
                        {% csrf_token %}
                        
                        <!-- Rerun Notification -->
                        {% if rerun_model %}
                        <div class="alert alert-info mb-4">
                            <h6><i class="fas fa-redo me-1"></i> Rerunning Training</h6>
                            <p class="mb-2">Configuration pre-populated from model: <strong>{{ rerun_model.name }}</strong></p>
                            <small class="text-muted">
                                Original training: {{ rerun_model.total_epochs }} epochs, 
                                Status: <span class="badge bg-{{ rerun_model.status|yesno:'success,danger' }}">{{ rerun_model.status|title }}</span>
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Template Selection -->
                        {% if form.template %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary">Quick Start</h5>
                                <hr>
                            </div>
                            <div class="col-md-8">
                                <label for="{{ form.template.id_for_label }}" class="form-label">
                                    {{ form.template.label }}
                                    {% if form.template.help_text %}
                                        <small class="text-muted">{{ form.template.help_text }}</small>
                                    {% endif %}
                                </label>
                                {{ form.template.errors }}
                                {{ form.template }}
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" id="load-template-btn" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Load Template
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary">Basic Information</h5>
                                <hr>
                            </div>
                        </div>
                        
                        <!-- Render all form fields except template (already handled above) -->
                        {% for field in form %}
                            {% if field.name != 'template' %}
                                {% if field.name == 'name' %}
                                    <!-- Basic Information Section -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="text" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:field.field.initial }}"
                                                   required>
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Data Path Field -->
                                            {% for data_field in form %}
                                                {% if data_field.name == 'data_path' %}
                                                    <label for="{{ data_field.id_for_label }}" class="form-label">
                                                        {{ data_field.label }}
                                                        {% if data_field.help_text %}
                                                            <small class="text-muted">{{ data_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ data_field.errors }}
                                                    <div class="input-group">
                                                        <input type="text" 
                                                               name="{{ data_field.html_name }}"
                                                               class="form-control"
                                                               id="{{ data_field.id_for_label }}"
                                                               value="{{ data_field.value|default:data_field.field.initial }}"
                                                               placeholder="e.g., /host/desktop/my_dataset or /app/data/datasets"
                                                               required>
                                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                            Browse Host
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><h6 class="dropdown-header">Host Directories</h6></li>
                                                            <li><a class="dropdown-item" href="#" onclick="setDataPath('/host/desktop')">
                                                                <i class="fas fa-desktop"></i> Desktop
                                                            </a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="setDataPath('/host/downloads')">
                                                                <i class="fas fa-download"></i> Downloads
                                                            </a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="setDataPath('/host/documents')">
                                                                <i class="fas fa-file-alt"></i> Documents
                                                            </a></li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><h6 class="dropdown-header">Container Paths</h6></li>
                                                            <li><a class="dropdown-item" href="#" onclick="setDataPath('/app/data/datasets')">
                                                                <i class="fas fa-heart"></i> Built-in Coronary Dataset
                                                            </a></li>
                                                        </ul>
                                                    </div>
                                                    <small class="text-muted">
                                                        Use /host/desktop, /host/downloads, or /host/documents to access files from your computer
                                                    </small>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Dataset Type Field -->
                                    <div class="row mb-3">
                                        {% for dataset_field in form %}
                                            {% if dataset_field.name == 'dataset_type' %}
                                                <div class="col-md-12">
                                                    <label for="{{ dataset_field.id_for_label }}" class="form-label">
                                                        {{ dataset_field.label }}
                                                        {% if dataset_field.help_text %}
                                                            <small class="text-muted">{{ dataset_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ dataset_field.errors }}
                                                    {{ dataset_field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Description Field -->
                                    {% for desc_field in form %}
                                        {% if desc_field.name == 'description' %}
                                            <div class="mb-3">
                                                <label for="{{ desc_field.id_for_label }}" class="form-label">
                                                    {{ desc_field.label }}
                                                    {% if desc_field.help_text %}
                                                        <small class="text-muted">{{ desc_field.help_text }}</small>
                                                    {% endif %}
                                                </label>
                                                {{ desc_field.errors }}
                                                <textarea name="{{ desc_field.html_name }}"
                                                          class="form-control"
                                                          id="{{ desc_field.id_for_label }}"
                                                          rows="3">{{ desc_field.value|default:desc_field.field.initial }}</textarea>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Model Configuration Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Model Configuration</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'model_type' %}
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            {{ field }}
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Batch Size Field -->
                                            {% for batch_field in form %}
                                                {% if batch_field.name == 'batch_size' %}
                                                    <label for="{{ batch_field.id_for_label }}" class="form-label">
                                                        {{ batch_field.label }}
                                                        {% if batch_field.help_text %}
                                                            <small class="text-muted">{{ batch_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ batch_field.errors }}
                                                    <input type="number" 
                                                           name="{{ batch_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ batch_field.id_for_label }}"
                                                           value="{{ batch_field.value|default:batch_field.field.initial }}"
                                                           min="{{ batch_field.field.min_value }}"
                                                           step="1">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Training Parameters Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Training Parameters</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'epochs' %}
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="number" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:field.field.initial }}"
                                                   min="{{ field.field.min_value }}"
                                                   step="1">
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Learning Rate Field -->
                                            {% for lr_field in form %}
                                                {% if lr_field.name == 'learning_rate' %}
                                                    <label for="{{ lr_field.id_for_label }}" class="form-label">
                                                        {{ lr_field.label }}
                                                        {% if lr_field.help_text %}
                                                            <small class="text-muted">{{ lr_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ lr_field.errors }}
                                                    <input type="number" 
                                                           name="{{ lr_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ lr_field.id_for_label }}"
                                                           value="{{ lr_field.value|default:lr_field.field.initial }}"
                                                           min="{{ lr_field.field.min_value }}"
                                                           step="any">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Optimizer Field -->
                                            {% for opt_field in form %}
                                                {% if opt_field.name == 'optimizer' %}
                                                    <label for="{{ opt_field.id_for_label }}" class="form-label">
                                                        {{ opt_field.label }}
                                                        {% if opt_field.help_text %}
                                                            <small class="text-muted">{{ opt_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ opt_field.errors }}
                                                    <select name="{{ opt_field.html_name }}"
                                                            class="form-control"
                                                            id="{{ opt_field.id_for_label }}">
                                                        {% for choice_value, choice_label in opt_field.field.choices %}
                                                            <option value="{{ choice_value }}" 
                                                                    {% if choice_value == opt_field.value|default:opt_field.field.initial %}selected{% endif %}>
                                                                {{ choice_label }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Learning Rate Scheduler Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">
                                                <i class="fas fa-chart-line me-1"></i>Learning Rate Scheduler
                                                <span class="badge bg-info ms-2" id="scheduler-status">Adaptive Training</span>
                                            </h5>
                                            <p class="text-muted small mb-2">Configure how the learning rate changes during training to improve convergence</p>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                    <!-- Scheduler Configuration Card -->
                                    <div class="card mb-4 border-info">
                                        <div class="card-body">
                                            <!-- Scheduler Type Selection -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <!-- LR Scheduler Type Field -->
                                                    {% for scheduler_field in form %}
                                                        {% if scheduler_field.name == 'lr_scheduler' %}
                                                            <label for="{{ scheduler_field.id_for_label }}" class="form-label fw-bold">
                                                                <i class="fas fa-cogs me-1"></i>{{ scheduler_field.label }}
                                                                {% if scheduler_field.help_text %}
                                                                    <small class="text-muted d-block fw-normal">{{ scheduler_field.help_text }}</small>
                                                                {% endif %}
                                                            </label>
                                                            {{ scheduler_field.errors }}
                                                            <select name="{{ scheduler_field.html_name }}"
                                                                    class="form-control"
                                                                    id="{{ scheduler_field.id_for_label }}"
                                                                    onchange="updateSchedulerFields(this.value)">
                                                                {% for choice_value, choice_label in scheduler_field.field.choices %}
                                                                    <option value="{{ choice_value }}" 
                                                                            {% if choice_value == scheduler_field.value|default:scheduler_field.field.initial %}selected{% endif %}>
                                                                        {{ choice_label }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-6">
                                                    <div id="scheduler-description" class="border rounded p-3 bg-light">
                                                        <h6 class="text-primary mb-2"><i class="fas fa-info-circle me-1"></i>Scheduler Info</h6>
                                                        <p class="small mb-0" id="scheduler-info-text">Select a scheduler to see its description</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Scheduler Parameters (organized by type) -->
                                            <div id="scheduler-params">
                                                <!-- Common Parameters Row -->
                                                <div class="row mb-3" id="common-params">
                                                    <div class="col-md-6">
                                                        <!-- Min LR Field -->
                                                        {% for min_lr_field in form %}
                                                            {% if min_lr_field.name == 'min_lr' %}
                                                                <label for="{{ min_lr_field.id_for_label }}" class="form-label">
                                                                    <i class="fas fa-arrow-down me-1"></i>{{ min_lr_field.label }}
                                                                    {% if min_lr_field.help_text %}
                                                                        <small class="text-muted d-block">{{ min_lr_field.help_text }}</small>
                                                                    {% endif %}
                                                                </label>
                                                                {{ min_lr_field.errors }}
                                                                <input type="number" 
                                                                       name="{{ min_lr_field.html_name }}"
                                                                       class="form-control"
                                                                       id="{{ min_lr_field.id_for_label }}"
                                                                       value="{{ min_lr_field.value|default:min_lr_field.field.initial }}"
                                                                       min="{{ min_lr_field.field.min_value }}"
                                                                       step="any">
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                
                                                <!-- Plateau Scheduler Parameters -->
                                                <div class="scheduler-group" id="plateau-params" style="display: none;">
                                                    <div class="border-start border-3 border-warning ps-3 mb-3">
                                                        <h6 class="text-warning mb-2"><i class="fas fa-chart-area me-1"></i>Plateau Scheduler Settings</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <!-- LR Patience Field -->
                                                                {% for patience_field in form %}
                                                                    {% if patience_field.name == 'lr_patience' %}
                                                                        <label for="{{ patience_field.id_for_label }}" class="form-label">
                                                                            <i class="fas fa-clock me-1"></i>{{ patience_field.label }}
                                                                            {% if patience_field.help_text %}
                                                                                <small class="text-muted d-block">{{ patience_field.help_text }}</small>
                                                                            {% endif %}
                                                                        </label>
                                                                        {{ patience_field.errors }}
                                                                        <input type="number" 
                                                                               name="{{ patience_field.html_name }}"
                                                                               class="form-control"
                                                                               id="{{ patience_field.id_for_label }}"
                                                                               value="{{ patience_field.value|default:patience_field.field.initial }}"
                                                                               min="{{ patience_field.field.min_value }}"
                                                                               step="1">
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                            <div class="col-md-6">
                                                                <!-- LR Factor Field -->
                                                                {% for factor_field in form %}
                                                                    {% if factor_field.name == 'lr_factor' %}
                                                                        <label for="{{ factor_field.id_for_label }}" class="form-label">
                                                                            <i class="fas fa-percentage me-1"></i>{{ factor_field.label }}
                                                                            {% if factor_field.help_text %}
                                                                                <small class="text-muted d-block">{{ factor_field.help_text }}</small>
                                                                            {% endif %}
                                                                        </label>
                                                                        {{ factor_field.errors }}
                                                                        <input type="number" 
                                                                               name="{{ factor_field.html_name }}"
                                                                               class="form-control"
                                                                               id="{{ factor_field.id_for_label }}"
                                                                               value="{{ factor_field.value|default:factor_field.field.initial }}"
                                                                               min="{{ factor_field.field.min_value }}"
                                                                               max="{{ factor_field.field.max_value }}"
                                                                               step="any">
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Step Scheduler Parameters -->
                                                <div class="scheduler-group" id="step-params" style="display: none;">
                                                    <div class="border-start border-3 border-success ps-3 mb-3">
                                                        <h6 class="text-success mb-2"><i class="fas fa-stairs me-1"></i>Step Scheduler Settings</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <!-- LR Step Size Field -->
                                                                {% for step_field in form %}
                                                                    {% if step_field.name == 'lr_step_size' %}
                                                                        <label for="{{ step_field.id_for_label }}" class="form-label">
                                                                            <i class="fas fa-step-forward me-1"></i>{{ step_field.label }}
                                                                            {% if step_field.help_text %}
                                                                                <small class="text-muted d-block">{{ step_field.help_text }}</small>
                                                                            {% endif %}
                                                                        </label>
                                                                        {{ step_field.errors }}
                                                                        <input type="number" 
                                                                               name="{{ step_field.html_name }}"
                                                                               class="form-control"
                                                                               id="{{ step_field.id_for_label }}"
                                                                               value="{{ step_field.value|default:step_field.field.initial }}"
                                                                               min="{{ step_field.field.min_value }}"
                                                                               step="1">
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                            <div class="col-md-6">
                                                                <!-- LR Gamma Field -->
                                                                {% for gamma_field in form %}
                                                                    {% if gamma_field.name == 'lr_gamma' %}
                                                                        <label for="{{ gamma_field.id_for_label }}" class="form-label">
                                                                            <i class="fas fa-calculator me-1"></i>{{ gamma_field.label }}
                                                                            {% if gamma_field.help_text %}
                                                                                <small class="text-muted d-block">{{ gamma_field.help_text }}</small>
                                                                            {% endif %}
                                                                        </label>
                                                                        {{ gamma_field.errors }}
                                                                        <input type="number" 
                                                                               name="{{ gamma_field.html_name }}"
                                                                               class="form-control"
                                                                               id="{{ gamma_field.id_for_label }}"
                                                                               value="{{ gamma_field.value|default:gamma_field.field.initial }}"
                                                                               min="{{ gamma_field.field.min_value }}"
                                                                               max="{{ gamma_field.field.max_value }}"
                                                                               step="any">
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Exponential Scheduler Parameters -->
                                                <div class="scheduler-group" id="exponential-params" style="display: none;">
                                                    <div class="border-start border-3 border-danger ps-3 mb-3">
                                                        <h6 class="text-danger mb-2"><i class="fas fa-chart-line me-1"></i>Exponential Scheduler Settings</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <!-- LR Gamma Field (reused) -->
                                                                <label class="form-label">
                                                                    <i class="fas fa-calculator me-1"></i>Decay Factor (Gamma)
                                                                    <small class="text-muted d-block">Multiplicative factor for exponential decay</small>
                                                                </label>
                                                                <p class="text-muted small">Uses the same gamma parameter as Step scheduler</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Validation Split Row -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <!-- Validation Split Field -->
                                            {% for val_field in form %}
                                                {% if val_field.name == 'validation_split' %}
                                                    <label for="{{ val_field.id_for_label }}" class="form-label">
                                                        {{ val_field.label }}
                                                        {% if val_field.help_text %}
                                                            <small class="text-muted">{{ val_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ val_field.errors }}
                                                    <input type="number" 
                                                           name="{{ val_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ val_field.id_for_label }}"
                                                           value="{{ val_field.value|default:val_field.field.initial }}"
                                                           min="{{ val_field.field.min_value }}"
                                                           max="{{ val_field.field.max_value }}"
                                                           step="any">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Resolution Field -->
                                    <div class="row mb-3">
                                        {% for res_field in form %}
                                            {% if res_field.name == 'resolution' %}
                                                <div class="col-md-6">
                                                    <label for="{{ res_field.id_for_label }}" class="form-label">
                                                        {{ res_field.label }}
                                                        {% if res_field.help_text %}
                                                            <small class="text-muted">{{ res_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ res_field.errors }}
                                                    {{ res_field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Device Field -->
                                        {% for device_field in form %}
                                            {% if device_field.name == 'device' %}
                                                <div class="col-md-6">
                                                    <label for="{{ device_field.id_for_label }}" class="form-label">
                                                        {{ device_field.label }}
                                                        {% if device_field.help_text %}
                                                            <small class="text-muted">{{ device_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ device_field.errors }}
                                                    {{ device_field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Data Augmentation Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Data Augmentation</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
                                        <!-- Flip Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-primary">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-arrows-alt-h me-1"></i> Random Flip</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_flip }}
                                                        <label class="form-check-label" for="{{ form.use_random_flip.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.flip_probability.id_for_label }}" class="form-label small">Flip Probability</label>
                                                    {{ form.flip_probability.errors }}
                                                    {{ form.flip_probability }}
                                                    <small class="text-muted d-block">{{ form.flip_probability.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Rotate Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-success">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-sync-alt me-1"></i> Random Rotate</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_rotate }}
                                                        <label class="form-check-label" for="{{ form.use_random_rotate.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.rotation_range.id_for_label }}" class="form-label small">Rotation Range (Â°)</label>
                                                    {{ form.rotation_range.errors }}
                                                    {{ form.rotation_range }}
                                                    <small class="text-muted d-block">{{ form.rotation_range.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Scale Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-warning">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-expand-arrows-alt me-1"></i> Random Scale</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_scale }}
                                                        <label class="form-check-label" for="{{ form.use_random_scale.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.scale_range_min.id_for_label }}" class="form-label small">Min Scale</label>
                                                        {{ form.scale_range_min.errors }}
                                                        {{ form.scale_range_min }}
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.scale_range_max.id_for_label }}" class="form-label small">Max Scale</label>
                                                        {{ form.scale_range_max.errors }}
                                                        {{ form.scale_range_max }}
                                                    </div>
                                                    <small class="text-muted d-block">Scale range (0.1-2.0)</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Intensity Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-info">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-adjust me-1"></i> Random Intensity</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_intensity }}
                                                        <label class="form-check-label" for="{{ form.use_random_intensity.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.intensity_range.id_for_label }}" class="form-label small">Intensity Range</label>
                                                    {{ form.intensity_range.errors }}
                                                    {{ form.intensity_range }}
                                                    <small class="text-muted d-block">{{ form.intensity_range.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Crop Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-secondary">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-crop-alt me-1"></i> Random Crop</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_crop }}
                                                        <label class="form-check-label" for="{{ form.use_random_crop.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.crop_size.id_for_label }}" class="form-label small">Crop Size (px)</label>
                                                    {{ form.crop_size.errors }}
                                                    {{ form.crop_size }}
                                                    <small class="text-muted d-block">{{ form.crop_size.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Elastic Transform Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-danger">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-wave-square me-1"></i> Elastic Transform</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_elastic_transform }}
                                                        <label class="form-check-label" for="{{ form.use_elastic_transform.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.elastic_alpha.id_for_label }}" class="form-label small">Alpha</label>
                                                        {{ form.elastic_alpha.errors }}
                                                        {{ form.elastic_alpha }}
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.elastic_sigma.id_for_label }}" class="form-label small">Sigma</label>
                                                        {{ form.elastic_sigma.errors }}
                                                        {{ form.elastic_sigma }}
                                                    </div>
                                                    <small class="text-muted d-block">Medical image deformation</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Gaussian Noise Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-dark">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-braille me-1"></i> Gaussian Noise</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_gaussian_noise }}
                                                        <label class="form-check-label" for="{{ form.use_gaussian_noise.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.noise_std.id_for_label }}" class="form-label small">Noise Std</label>
                                                    {{ form.noise_std.errors }}
                                                    {{ form.noise_std }}
                                                    <small class="text-muted d-block">{{ form.noise_std.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Settings Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Advanced Settings</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ form.num_workers.id_for_label }}" class="form-label">
                                                {{ form.num_workers.label }}
                                                {% if form.num_workers.help_text %}
                                                    <small class="text-muted">{{ form.num_workers.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ form.num_workers.errors }}
                                            {{ form.num_workers }}
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'crop_size' %}
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="number" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:field.field.initial }}"
                                                   min="{{ field.field.min_value }}"
                                                   step="1">
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'ml_manager:model-list' %}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play"></i> Start Training
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('template-select');
    const loadTemplateBtn = document.getElementById('load-template-btn');
    
    if (templateSelect && loadTemplateBtn) {
        loadTemplateBtn.addEventListener('click', function() {
            const templateId = templateSelect.value;
            if (!templateId) {
                alert('Please select a template first.');
                return;
            }
            
            // Show loading state
            loadTemplateBtn.disabled = true;
            loadTemplateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            // Fetch template data
            fetch(`{% url 'ml_manager:get-template-data' 0 %}`.replace('0', templateId))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Populate form fields with template data
                        const templateData = data.data;
                        
                        for (const [fieldName, value] of Object.entries(templateData)) {
                            const field = document.querySelector(`[name="${fieldName}"]`);
                            if (field) {
                                if (field.type === 'checkbox') {
                                    field.checked = value;
                                } else {
                                    field.value = value;
                                }
                            }
                        }
                        
                        // Update scheduler fields after loading template
                        const schedulerSelect = document.querySelector('[name="lr_scheduler"]');
                        if (schedulerSelect) {
                            updateSchedulerFields(schedulerSelect.value);
                        }
                        
                        // Show success message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            Template loaded successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        
                        const form = document.getElementById('training-form');
                        form.insertBefore(alertDiv, form.firstChild);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 3000);
                        
                    } else {
                        alert('Error loading template: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    alert('Error loading template. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    loadTemplateBtn.disabled = false;
                    loadTemplateBtn.innerHTML = '<i class="fas fa-download"></i> Load Template';
                });
        });
    }
    
    // Handle URL parameter for pre-selecting template
    const urlParams = new URLSearchParams(window.location.search);
    const templateParam = urlParams.get('template');
    if (templateParam && templateSelect) {
        templateSelect.value = templateParam;
        // Auto-load the template
        loadTemplateBtn.click();
    }
    
    // Initialize scheduler fields on page load
    const schedulerSelect = document.querySelector('[name="lr_scheduler"]');
    if (schedulerSelect) {
        updateSchedulerFields(schedulerSelect.value);
    }
});

// Function to set data path from dropdown
function setDataPath(path) {
    const dataPathField = document.querySelector('[name="data_path"]');
    if (dataPathField) {
        dataPathField.value = path;
    }
}

// Function to update scheduler fields based on selected type
function updateSchedulerFields(schedulerType) {
    // Hide all scheduler parameter groups
    const groups = document.querySelectorAll('.scheduler-group');
    groups.forEach(group => {
        group.style.display = 'none';
    });
    
    // Scheduler descriptions
    const descriptions = {
        'none': {
            text: 'No learning rate scheduling. The learning rate remains constant throughout training.',
            status: 'Fixed LR',
            color: 'secondary'
        },
        'plateau': {
            text: 'Reduces learning rate when validation loss stops improving. Monitors plateau and reduces LR by a factor after patience epochs.',
            status: 'Adaptive',
            color: 'warning'
        },
        'step': {
            text: 'Reduces learning rate at fixed epoch intervals. LR is multiplied by gamma every step_size epochs.',
            status: 'Step-wise',
            color: 'success'
        },
        'exponential': {
            text: 'Exponentially decays the learning rate each epoch. LR is multiplied by gamma every epoch.',
            status: 'Exponential',
            color: 'danger'
        },
        'cosine': {
            text: 'Cosine annealing scheduler that varies learning rate following a cosine function. Provides smooth decay.',
            status: 'Cosine',
            color: 'info'
        },
        'adaptive': {
            text: 'Custom adaptive scheduler that automatically adjusts learning rate based on training dynamics.',
            status: 'Custom',
            color: 'primary'
        }
    };
    
    // Update description and status
    const infoText = document.getElementById('scheduler-info-text');
    const statusBadge = document.getElementById('scheduler-status');
    
    if (descriptions[schedulerType]) {
        infoText.textContent = descriptions[schedulerType].text;
        statusBadge.textContent = descriptions[schedulerType].status;
        statusBadge.className = `badge bg-${descriptions[schedulerType].color} ms-2`;
    }
    
    // Show relevant parameter groups
    switch (schedulerType) {
        case 'plateau':
            document.getElementById('plateau-params').style.display = 'block';
            break;
        case 'step':
            document.getElementById('step-params').style.display = 'block';
            break;
        case 'exponential':
            document.getElementById('exponential-params').style.display = 'block';
            break;
        case 'cosine':
            // Cosine scheduler typically doesn't need additional parameters beyond min_lr
            break;
        case 'adaptive':
            // Custom adaptive might use various parameters
            document.getElementById('plateau-params').style.display = 'block';
            break;
    }
}
</script>

{% endblock %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // CRITICAL: Apply theme class immediately to prevent flash
        (function() {
            var saved = localStorage.getItem('colorMode');
            var isDark = saved === 'dark';
            
            // Only apply class, don't inject aggressive CSS
            document.documentElement.className = isDark ? 'theme-dark-immediate' : 'theme-light-immediate';
        })();
    </script>
    <title>{% block title %}ML Manager{% endblock %}</title>
    <style>
        /* CRITICAL: Immediate dark mode application - only affects main background */
        html {
            background-color: #ffffff;
            transition: background-color 0s;
        }
        
        html.theme-dark-immediate {
            background-color: #181a1b !important;
        }
        
        html.theme-dark-immediate body {
            background-color: #181a1b !important;
            color: #e0e0e0 !important;
        }
        
        html.theme-light-immediate body {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        /* Prevent transitions during initial load - but don't affect all elements */
        html.theme-dark-immediate body,
        html.theme-light-immediate body {
            transition: none !important;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    {% block extra_css %}
    {% endblock %}
    <link rel="icon" type="image/x-icon" href="{% static 'ml_manager/favicon.ico' %}">
    <style>
:root {
    --primary: #3490dc;
    --secondary: #6c757d;
    --success: #38c172;
    --danger: #e3342f;
    --warning: #f6993f;
    --info: #6cb2eb;
    --light: #f8f9fa;
    --dark: #181a1b;
    --accent: #9f7aea;
}
body[data-color-mode="dark"] {
    background: #181a1b !important;
    color: #e0e0e0 !important;
}
body[data-color-mode="dark"] .card,
body[data-color-mode="dark"] .table,
body[data-color-mode="dark"] .form-control,
body[data-color-mode="dark"] .input-group,
body[data-color-mode="dark"] .btn,
body[data-color-mode="dark"] .navbar,
body[data-color-mode="dark"] .dropdown-menu,
body[data-color-mode="dark"] .modal-content {
    background: #23272b !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
body[data-color-mode="dark"] .form-control,
body[data-color-mode="dark"] .input-group {
    background: #23272b !important;
    color: #e0e0e0 !important;
    border: 1px solid #444 !important;
}
body[data-color-mode="dark"] th,
body[data-color-mode="dark"] td,
body[data-color-mode="dark"] .table th,
body[data-color-mode="dark"] .table td,
body[data-color-mode="dark"] .table thead th,
body[data-color-mode="dark"] .table thead td,
body[data-color-mode="dark"] .table-dark th,
body[data-color-mode="dark"] .table-dark td,
body[data-color-mode="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * {
    color: #e0e0e0 !important;
    background: #23272b !important;
}
body[data-color-mode="dark"] .table thead th {
    color: #fff !important;
    background: #23272b !important;
    border-bottom: 2px solid #444 !important;
}
body[data-color-mode="dark"] .table thead tr th,
body[data-color-mode="dark"] .table thead tr td {
    color: #fff !important;
}
body[data-color-mode="dark"] .table th,
body[data-color-mode="dark"] .table td {
    border-color: #444 !important;
}
body[data-color-mode="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * {
    background: #262a2e !important;
}
body[data-color-mode="dark"] .table-hover > tbody > tr:hover > * {
    background: #2d3238 !important;
    color: #fff !important;
}
body[data-color-mode="dark"] .text-table-header,
body[data-color-mode="dark"] .text-table-header th {
    color: #fff !important;
}
body[data-color-mode="dark"] a,
body[data-color-mode="dark"] .nav-link,
body[data-color-mode="dark"] .navbar-brand {
    color: #6cb2eb !important;
}
body[data-color-mode="dark"] a:hover,
body[data-color-mode="dark"] .nav-link:hover,
body[data-color-mode="dark"] .navbar-brand:hover {
    color: #f6993f !important;
}
body[data-color-mode="dark"] h1, body[data-color-mode="dark"] h2, body[data-color-mode="dark"] h3, body[data-color-mode="dark"] h4, body[data-color-mode="dark"] h5, body[data-color-mode="dark"] h6 {
    color: #fff !important;
}
body[data-color-mode="light"] {
    background: #fff !important;
    color: #222 !important;
}
.navbar, .navbar-dark {
    background: var(--primary) !important;
    color: #fff !important;
}
.navbar .navbar-brand, .navbar .nav-link {
    color: #fff !important;
}
.navbar .navbar-brand:hover, .navbar .nav-link:hover {
    color: var(--warning) !important;
}
.card {
    border-left: 5px solid var(--accent);
    box-shadow: 0 2px 8px rgba(52,144,220,0.08);
    background: var(--light) !important;
    color: #222 !important;
}
body[data-color-mode="dark"] .card {
    background: #23272b !important;
    color: #e0e0e0 !important;
}
h1, h2, h3, h4, h5, h6 {
    color: #222 !important;
}
a, .nav-link, .navbar-brand {
    color: var(--primary) !important;
}
a:hover, .nav-link:hover, .navbar-brand:hover {
    color: var(--warning) !important;
}
.btn-primary {
    background: var(--primary) !important;
    border-color: var(--primary) !important;
    color: #fff !important;
}
.btn-success {
    background: var(--success) !important;
    border-color: var(--success) !important;
    color: #fff !important;
}
.btn-danger {
    background: var(--danger) !important;
    border-color: var(--danger) !important;
    color: #fff !important;
}
.btn-warning {
    background: var(--warning) !important;
    border-color: var(--warning) !important;
    color: #222 !important;
}
.btn-info {
    background: var(--info) !important;
    border-color: var(--info) !important;
    color: #fff !important;
}
.table-primary th, .table-primary td {
    background: var(--light) !important;
    color: var(--primary) !important;
}
.table-dark th, .table-dark td {
    background: var(--dark) !important;
    color: var(--light) !important;
}
hr { border-color: var(--accent); }
::-webkit-scrollbar { background: var(--dark); }
::-webkit-scrollbar-thumb { background: var(--primary); }
#toggle-dark {
    position:fixed;top:10px;right:10px;z-index:9999;
}
body[data-color-mode="dark"] .list-group,
body[data-color-mode="dark"] .list-group-item {
    background: #23272b !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
body[data-color-mode="dark"] .list-group {
    background-color: #23272b !important;
}
body[data-color-mode="dark"] .list-group-item {
    background-color: #23272b !important;
    color: #e0e0e0 !important;
    border-color: #444 !important;
}
body[data-color-mode="dark"] .list-group-item.active,
body[data-color-mode="dark"] .list-group-item:hover {
    background: #3490dc !important;
    background-color: #3490dc !important;
    color: #fff !important;
    border-color: #3490dc !important;
}
body[data-color-mode="dark"] .text-dark,
body[data-color-mode="dark"] .text-secondary,
body[data-color-mode="dark"] .text-muted,
body[data-color-mode="dark"] .text-body,
body[data-color-mode="dark"] .text-black,
body[data-color-mode="dark"] .text-white-50 {
    color: #b0b0b0 !important;
}
body[data-color-mode="dark"] .bg-light,
body[data-color-mode="dark"] .table-light,
body[data-color-mode="dark"] .bg-white {
    background: #23272b !important;
    color: #e0e0e0 !important;
}
body[data-color-mode="dark"] .border,
body[data-color-mode="dark"] .border-light {
    border-color: #444 !important;
}
body[data-color-mode="dark"] .form-label,
body[data-color-mode="dark"] label,
body[data-color-mode="dark"] .form-check-label {
    color: #e0e0e0 !important;
}
body[data-color-mode="dark"] .dropdown-menu {
    background: #23272b !important;
    color: #e0e0e0 !important;
}
body[data-color-mode="dark"] .dropdown-item {
    color: #e0e0e0 !important;
}
body[data-color-mode="dark"] .dropdown-item.active,
body[data-color-mode="dark"] .dropdown-item:active,
body[data-color-mode="dark"] .dropdown-item:hover {
    background: #3490dc !important;
    color: #fff !important;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="{% url 'ml_manager:model-list' %}">
                <i class="fas fa-brain"></i> ML Manager
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ml_manager:model-list' %}">
                            <i class="fas fa-list"></i> Models
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ml_manager:start-training' %}">
                            <i class="fas fa-play"></i> Start Training
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ml_manager:template-list' %}">
                            <i class="fas fa-clipboard-list"></i> Templates
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        {% block content %}
        {% endblock %}
    </div>

    <button id="toggle-dark" class="btn btn-sm btn-secondary">Toggle Dark/Light Mode</button>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
// Dark mode toggle functionality - fixed for consistency and no flash
(function() {
    function setMode(mode, immediate) {
        // Remove both old and new loading classes
        document.documentElement.classList.remove('theme-dark-immediate', 'theme-light-immediate', 'dark-theme-loading', 'light-theme-loading');
        
        // Remove old mode classes  
        document.body.classList.remove('dark-mode', 'light-mode');
        
        // Add new mode
        document.body.classList.add(mode + '-mode');
        document.body.setAttribute('data-color-mode', mode);
        localStorage.setItem('colorMode', mode);
        
        // Apply immediate theme class to html for flash prevention
        if (mode === 'dark') {
            document.documentElement.classList.add('theme-dark-immediate');
        } else {
            document.documentElement.classList.add('theme-light-immediate');
        }
        
        // Only add transitions after initial load to prevent flash
        if (!immediate) {
            setTimeout(function() {
                document.documentElement.classList.remove('theme-dark-immediate', 'theme-light-immediate');
                document.body.style.transition = 'background-color 0.2s ease, color 0.2s ease';
            }, 100);
        }
    }
    
    // Apply the correct theme immediately on script execution
    var saved = localStorage.getItem('colorMode');
    var mode = saved === 'dark' ? 'dark' : 'light';
    setMode(mode, true);
    
    // Re-apply theme when DOM is loaded
    window.addEventListener('DOMContentLoaded', function() {
        var saved = localStorage.getItem('colorMode');
        var mode = saved === 'dark' ? 'dark' : 'light';
        setMode(mode, true);
        
        // Setup toggle button
        var toggleBtn = document.getElementById('toggle-dark');
        if (toggleBtn) {
            toggleBtn.onclick = function() {
                setMode(document.body.classList.contains('dark-mode') ? 'light' : 'dark', false);
            };
        }
        
        // Remove immediate theme classes after DOM is fully loaded
        setTimeout(function() {
            document.documentElement.classList.remove('theme-dark-immediate', 'theme-light-immediate');
        }, 200);
    });
    
    // Handle page visibility changes (switching between windows)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            var saved = localStorage.getItem('colorMode');
            var mode = saved === 'dark' ? 'dark' : 'light';
            setMode(mode, true);
        }
    });
    
    // Handle focus events for additional insurance
    window.addEventListener('focus', function() {
        var saved = localStorage.getItem('colorMode');
        var mode = saved === 'dark' ? 'dark' : 'light';
        setMode(mode, true);
    });
    
    // Handle page show event (when coming from cache)
    window.addEventListener('pageshow', function(event) {
        var saved = localStorage.getItem('colorMode');
        var mode = saved === 'dark' ? 'dark' : 'light';
        setMode(mode, true);
    });
    
    // Prepare for page navigation
    window.addEventListener('beforeunload', function() {
        var saved = localStorage.getItem('colorMode');
        if (saved === 'dark') {
            document.documentElement.classList.add('theme-dark-immediate');
        } else {
            document.documentElement.classList.add('theme-light-immediate');
        }
    });
})();
</script>
    {% block extra_js %}
    {% endblock %}
</body>
</html>

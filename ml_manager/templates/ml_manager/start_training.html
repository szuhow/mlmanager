{% extends "ml_manager/base.html" %}

{% block title %}Start Training - ML Manager{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Start New Training</h2>
                <div>
                    <a href="{% url 'ml_manager:template-list' %}" class="btn btn-info">
                        <i class="fas fa-clipboard-list"></i> Manage Templates
                    </a>
                    <a href="{% url 'ml_manager:model-list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Models
                    </a>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Training Configuration</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="training-form">
                        {% csrf_token %}
                        
                        <!-- Rerun Notification -->
                        {% if rerun_model %}
                        <div class="alert alert-info mb-4">
                            <h6><i class="fas fa-redo me-1"></i> Rerunning Training</h6>
                            <p class="mb-2">Configuration pre-populated from model: <strong>{{ rerun_model.name }}</strong></p>
                            <small class="text-muted">
                                Original training: {{ rerun_model.epochs }} epochs, 
                                Status: <span class="badge bg-{{ rerun_model.status|yesno:'success,danger' }}">{{ rerun_model.status|title }}</span>
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Template Selection -->
                        {% if form.template %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary">Quick Start</h5>
                                <hr>
                            </div>
                            <div class="col-md-8">
                                <label for="{{ form.template.id_for_label }}" class="form-label">
                                    {{ form.template.label }}
                                    {% if form.template.help_text %}
                                        <small class="text-muted">{{ form.template.help_text }}</small>
                                    {% endif %}
                                </label>
                                {{ form.template.errors }}
                                {{ form.template }}
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" id="load-template-btn" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Load Template
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary">Basic Information</h5>
                                <hr>
                            </div>
                        </div>
                        
                        <!-- Render all form fields except template (already handled above) -->
                        {% for field in form %}
                            {% if field.name != 'template' %}
                                {% if field.name == 'name' %}
                                    <!-- Basic Information Section -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="text" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:'' }}"
                                                   required>
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Data Path Field -->
                                            {% for data_field in form %}
                                                {% if data_field.name == 'data_path' %}
                                                    <label for="{{ data_field.id_for_label }}" class="form-label">
                                                        {{ data_field.label }}
                                                        {% if data_field.help_text %}
                                                            <small class="text-muted">{{ data_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ data_field.errors }}
                                                    <input type="text" 
                                                           name="{{ data_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ data_field.id_for_label }}"
                                                           value="{{ data_field.value|default:'' }}"
                                                           required>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Description Field -->
                                    {% for desc_field in form %}
                                        {% if desc_field.name == 'description' %}
                                            <div class="mb-3">
                                                <label for="{{ desc_field.id_for_label }}" class="form-label">
                                                    {{ desc_field.label }}
                                                    {% if desc_field.help_text %}
                                                        <small class="text-muted">{{ desc_field.help_text }}</small>
                                                    {% endif %}
                                                </label>
                                                {{ desc_field.errors }}
                                                <textarea name="{{ desc_field.html_name }}"
                                                          class="form-control"
                                                          id="{{ desc_field.id_for_label }}"
                                                          rows="3">{{ desc_field.value|default:'' }}</textarea>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Model Configuration Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Model Configuration</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'model_type' %}
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            {{ field }}
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Batch Size Field -->
                                            {% for batch_field in form %}
                                                {% if batch_field.name == 'batch_size' %}
                                                    <label for="{{ batch_field.id_for_label }}" class="form-label">
                                                        {{ batch_field.label }}
                                                        {% if batch_field.help_text %}
                                                            <small class="text-muted">{{ batch_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ batch_field.errors }}
                                                    <input type="number" 
                                                           name="{{ batch_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ batch_field.id_for_label }}"
                                                           value="{{ batch_field.value|default:batch_field.field.initial }}"
                                                           min="{{ batch_field.field.min_value }}"
                                                           step="1">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Training Parameters Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Training Parameters</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'epochs' %}
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="number" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:field.field.initial }}"
                                                   min="{{ field.field.min_value }}"
                                                   step="1">
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Learning Rate Field -->
                                            {% for lr_field in form %}
                                                {% if lr_field.name == 'learning_rate' %}
                                                    <label for="{{ lr_field.id_for_label }}" class="form-label">
                                                        {{ lr_field.label }}
                                                        {% if lr_field.help_text %}
                                                            <small class="text-muted">{{ lr_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ lr_field.errors }}
                                                    <input type="number" 
                                                           name="{{ lr_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ lr_field.id_for_label }}"
                                                           value="{{ lr_field.value|default:lr_field.field.initial }}"
                                                           min="{{ lr_field.field.min_value }}"
                                                           step="any">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-4">
                                            <!-- Validation Split Field -->
                                            {% for val_field in form %}
                                                {% if val_field.name == 'validation_split' %}
                                                    <label for="{{ val_field.id_for_label }}" class="form-label">
                                                        {{ val_field.label }}
                                                        {% if val_field.help_text %}
                                                            <small class="text-muted">{{ val_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ val_field.errors }}
                                                    <input type="number" 
                                                           name="{{ val_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ val_field.id_for_label }}"
                                                           value="{{ val_field.value|default:val_field.field.initial }}"
                                                           min="{{ val_field.field.min_value }}"
                                                           max="{{ val_field.field.max_value }}"
                                                           step="any">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Resolution Field -->
                                    <div class="row mb-3">
                                        {% for res_field in form %}
                                            {% if res_field.name == 'resolution' %}
                                                <div class="col-md-6">
                                                    <label for="{{ res_field.id_for_label }}" class="form-label">
                                                        {{ res_field.label }}
                                                        {% if res_field.help_text %}
                                                            <small class="text-muted">{{ res_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ res_field.errors }}
                                                    {{ res_field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Device Field -->
                                        {% for device_field in form %}
                                            {% if device_field.name == 'device' %}
                                                <div class="col-md-6">
                                                    <label for="{{ device_field.id_for_label }}" class="form-label">
                                                        {{ device_field.label }}
                                                        {% if device_field.help_text %}
                                                            <small class="text-muted">{{ device_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ device_field.errors }}
                                                    {{ device_field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Data Augmentation Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Data Augmentation</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
                                        <!-- Flip Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-primary">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-arrows-alt-h me-1"></i> Random Flip</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_flip }}
                                                        <label class="form-check-label" for="{{ form.use_random_flip.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.flip_probability.id_for_label }}" class="form-label small">Flip Probability</label>
                                                    {{ form.flip_probability.errors }}
                                                    {{ form.flip_probability }}
                                                    <small class="text-muted d-block">{{ form.flip_probability.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Rotate Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-success">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-sync-alt me-1"></i> Random Rotate</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_rotate }}
                                                        <label class="form-check-label" for="{{ form.use_random_rotate.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.rotation_range.id_for_label }}" class="form-label small">Rotation Range (°)</label>
                                                    {{ form.rotation_range.errors }}
                                                    {{ form.rotation_range }}
                                                    <small class="text-muted d-block">{{ form.rotation_range.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Scale Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-warning">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-expand-arrows-alt me-1"></i> Random Scale</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_scale }}
                                                        <label class="form-check-label" for="{{ form.use_random_scale.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.scale_range_min.id_for_label }}" class="form-label small">Min Scale</label>
                                                        {{ form.scale_range_min.errors }}
                                                        {{ form.scale_range_min }}
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.scale_range_max.id_for_label }}" class="form-label small">Max Scale</label>
                                                        {{ form.scale_range_max.errors }}
                                                        {{ form.scale_range_max }}
                                                    </div>
                                                    <small class="text-muted d-block">Scale range (0.1-2.0)</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Intensity Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-info">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-adjust me-1"></i> Random Intensity</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_intensity }}
                                                        <label class="form-check-label" for="{{ form.use_random_intensity.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.intensity_range.id_for_label }}" class="form-label small">Intensity Range</label>
                                                    {{ form.intensity_range.errors }}
                                                    {{ form.intensity_range }}
                                                    <small class="text-muted d-block">{{ form.intensity_range.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Crop Augmentation Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-secondary">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-crop-alt me-1"></i> Random Crop</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_random_crop }}
                                                        <label class="form-check-label" for="{{ form.use_random_crop.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.crop_size.id_for_label }}" class="form-label small">Crop Size (px)</label>
                                                    {{ form.crop_size.errors }}
                                                    {{ form.crop_size }}
                                                    <small class="text-muted d-block">{{ form.crop_size.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Elastic Transform Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-danger">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-wave-square me-1"></i> Elastic Transform</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_elastic_transform }}
                                                        <label class="form-check-label" for="{{ form.use_elastic_transform.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.elastic_alpha.id_for_label }}" class="form-label small">Alpha</label>
                                                        {{ form.elastic_alpha.errors }}
                                                        {{ form.elastic_alpha }}
                                                    </div>
                                                    <div class="mb-2">
                                                        <label for="{{ form.elastic_sigma.id_for_label }}" class="form-label small">Sigma</label>
                                                        {{ form.elastic_sigma.errors }}
                                                        {{ form.elastic_sigma }}
                                                    </div>
                                                    <small class="text-muted d-block">Medical image deformation</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Gaussian Noise Card -->
                                        <div class="col">
                                            <div class="card h-100 shadow-sm border-dark">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-braille me-1"></i> Gaussian Noise</h6>
                                                    <div class="form-check mb-2">
                                                        {{ form.use_gaussian_noise }}
                                                        <label class="form-check-label" for="{{ form.use_gaussian_noise.id_for_label }}">
                                                            Enable
                                                        </label>
                                                    </div>
                                                    <label for="{{ form.noise_std.id_for_label }}" class="form-label small">Noise Std</label>
                                                    {{ form.noise_std.errors }}
                                                    {{ form.noise_std }}
                                                    <small class="text-muted d-block">{{ form.noise_std.help_text }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Settings Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h5 class="text-primary">Advanced Settings</h5>
                                            <hr>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ form.num_workers.id_for_label }}" class="form-label">
                                                {{ form.num_workers.label }}
                                                {% if form.num_workers.help_text %}
                                                    <small class="text-muted">{{ form.num_workers.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ form.num_workers.errors }}
                                            {{ form.num_workers }}
                                        </div>
                                    </div>
                                    
                                {% elif field.name == 'crop_size' %}
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.help_text %}
                                                    <small class="text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                            </label>
                                            {{ field.errors }}
                                            <input type="number" 
                                                   name="{{ field.html_name }}"
                                                   class="form-control"
                                                   id="{{ field.id_for_label }}"
                                                   value="{{ field.value|default:field.field.initial }}"
                                                   min="{{ field.field.min_value }}"
                                                   step="1">
                                        </div>
                                        <div class="col-md-6">
                                            <!-- Num Workers Field -->
                                            {% for workers_field in form %}
                                                {% if workers_field.name == 'num_workers' %}
                                                    <label for="{{ workers_field.id_for_label }}" class="form-label">
                                                        {{ workers_field.label }}
                                                        {% if workers_field.help_text %}
                                                            <small class="text-muted">{{ workers_field.help_text }}</small>
                                                        {% endif %}
                                                    </label>
                                                    {{ workers_field.errors }}
                                                    <input type="number" 
                                                           name="{{ workers_field.html_name }}"
                                                           class="form-control"
                                                           id="{{ workers_field.id_for_label }}"
                                                           value="{{ workers_field.value|default:workers_field.field.initial }}"
                                                           min="{{ workers_field.field.min_value }}"
                                                           step="1">
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'ml_manager:model-list' %}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play"></i> Start Training
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('template-select');
    const loadTemplateBtn = document.getElementById('load-template-btn');
    
    if (templateSelect && loadTemplateBtn) {
        loadTemplateBtn.addEventListener('click', function() {
            const templateId = templateSelect.value;
            if (!templateId) {
                alert('Please select a template first.');
                return;
            }
            
            // Show loading state
            loadTemplateBtn.disabled = true;
            loadTemplateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            // Fetch template data
            fetch(`{% url 'ml_manager:get-template-data' 0 %}`.replace('0', templateId))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Populate form fields with template data
                        const templateData = data.data;
                        
                        for (const [fieldName, value] of Object.entries(templateData)) {
                            const field = document.querySelector(`[name="${fieldName}"]`);
                            if (field) {
                                if (field.type === 'checkbox') {
                                    field.checked = value;
                                } else {
                                    field.value = value;
                                }
                            }
                        }
                        
                        // Show success message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            Template loaded successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        
                        const form = document.getElementById('training-form');
                        form.insertBefore(alertDiv, form.firstChild);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 3000);
                        
                    } else {
                        alert('Error loading template: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    alert('Error loading template. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    loadTemplateBtn.disabled = false;
                    loadTemplateBtn.innerHTML = '<i class="fas fa-download"></i> Load Template';
                });
        });
    }
    
    // Handle URL parameter for pre-selecting template
    const urlParams = new URLSearchParams(window.location.search);
    const templateParam = urlParams.get('template');
    if (templateParam && templateSelect) {
        templateSelect.value = templateParam;
        // Auto-load the template
        loadTemplateBtn.click();
    }
});
</script>

{% endblock %}
